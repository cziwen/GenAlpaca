# GenAlpaca - 财报分析问答生成系统

一个基于OpenAI API的财报分析问答生成系统，能够自动提取财报关键信息并生成专业的问题或分析报告。

## 功能特性

- 📊 智能财报摘要（使用便宜的GPT-4o-mini模型）
- 🤖 基于OpenAI API生成专业问题或分析
- 🎲 随机选择多种prompt模板（中英文混合）
- 📝 输出标准JSONL格式结果
- 🔄 支持重试机制和错误处理
- 📋 详细的日志记录
- 🔄 自动回退机制（GPT失败时使用TF-IDF）
- ⚡ **多进程并行处理**，大幅提升处理速度
- 📈 **实时进度条**显示处理进度
- 🔄 **断点续传功能**，支持中断后恢复
- 💾 **流式写入**，避免内存溢出
- 🎯 **滚动窗口处理**，高效处理大量文件

## 安装依赖

```bash
pip install openai pyyaml scikit-learn
```

## 配置设置

1. 复制环境变量示例文件：
```bash
cp env_example.txt .env
```

2. 编辑 `.env` 文件，设置你的OpenAI API密钥：
```bash
OPENAI_API_KEY=your_actual_api_key_here
```

3. 根据需要修改 `config/config.yaml` 中的配置参数

## 使用方法

### 基本使用

1. 将财报文本文件（.txt格式）放入 `data/raw/` 目录

2. 运行主程序：
```bash
python main.py
```

3. 查看结果：
   - 分析结果保存在 `output/report_qa.jsonl`
   - 日志文件保存在 `output/logs.txt`
   - 进度文件保存在 `output/saves.txt`

### 断点续传

如果程序中断，可以使用resume功能继续处理：

```bash
# 从指定进度文件恢复
python main.py -r output/saves.txt

# 从自定义进度文件恢复
python main.py -r my_progress.txt
```

### 处理大量文件

系统自动使用多进程并行处理，支持：
- **滚动窗口读取**：避免内存溢出
- **流式写入**：实时保存结果
- **进度跟踪**：显示处理进度
- **断点续传**：支持中断恢复

## 配置说明

### 多进程处理设置
- `max_workers`: 最大进程数（默认：4）
- `batch_size`: 每个进程处理的文件数量（默认：10）
- `max_tokens_per_worker`: 每个worker处理的最大token数（默认：50000）

### 主要模型设置
- `model`: 问题生成模型（默认：gpt-4o）
- `temperature`: 生成温度（默认：0.7）
- `max_tokens`: 最大输出token数（默认：2048）

### 摘要模型设置
- `summary_model`: 摘要使用的模型（默认：gpt-4o-mini）
- `summary_max_tokens`: 摘要最大token数（默认：2048）
- `summary_temperature`: 摘要温度（默认：0.3）
- `max_chunk_size`: 文本分块大小（默认：100000）

### 其他设置
- `top_k_sentences`: 提取的关键句子数量（默认：50）
- `max_questions`: 最大问题数量（默认：1）
- `retry_attempts`: API调用重试次数（默认：2）
- `retry_backoff`: 重试延迟倍数（默认：2）

## 性能优化特性

### 多进程并行处理
- 自动使用多个进程并行处理文件
- 每个进程独立处理一批文件
- 大幅提升处理速度

### 滚动窗口处理
- 动态读取文件，避免一次性加载所有文件到内存
- 支持处理大量文件而不会内存溢出
- 实时释放已处理文件的内存

### 流式写入
- 每个worker完成后立即写入结果
- 避免在内存中累积大量数据
- 支持处理超大数据集

### 断点续传
- 自动保存处理进度
- 支持程序中断后恢复
- 跳过已完成的文件，只处理剩余文件

## 智能摘要功能

### 工作原理
1. **文本分块**：将长财报文本分割成适合处理的块
2. **GPT摘要**：使用便宜的GPT-4o-mini模型对每个块进行摘要
3. **信息保留**：专门设计的prompt确保保留所有重要财务数据和细节
4. **合并压缩**：将多个摘要合并，必要时进行二次压缩
5. **回退机制**：如果GPT摘要失败，自动回退到TF-IDF方法

### 优势
- **成本效益**：使用便宜的GPT-4o-mini模型进行摘要
- **信息完整**：保留所有重要的财务数据、数字和业务细节
- **智能处理**：自动处理超长文本，分段摘要后合并
- **稳定可靠**：内置回退机制，确保系统稳定运行

## Prompt模板

系统内置了多个不同的prompt模板，包含中英文混合内容，每次API调用时会随机选择一个模板。模板涵盖：
- 财务分析角度
- 风险识别角度
- 投资价值角度
- 战略发展角度
- 市场竞争角度

你可以通过修改 `prompts/templates.txt` 文件来自定义或添加新的模板。

## 输出格式

每个输出项包含：
- `instruction`: 问题或分析指令
- `input`: 文本上下文（可选）
- `output`: 对应的回答或分析结果

## 项目结构

```
GenAlpaca/
├── api/
│   └── batch_processor.py        # 批量处理器（多进程）
├── config/
│   └── config.yaml               # 配置文件
├── data/
│   └── raw/                      # 输入数据目录
├── output/                       # 输出目录
│   ├── report_qa.jsonl          # 分析结果
│   ├── logs.txt                 # 日志文件
│   └── saves.txt                # 进度文件
├── prompts/
│   ├── templates.txt             # Prompt模板
│   └── README.md                 # 模板使用说明
├── utils/
│   ├── text_processor.py         # 统一的文本处理模块
│   └── logger.py                 # 日志工具
├── main.py                       # 主程序
├── README.md                     # 项目文档
├── requirements.txt              # 依赖列表
├── .gitignore                    # Git忽略文件
└── env_example.txt               # 环境变量示例
```

## 使用示例

### 处理小批量文件
```bash
# 正常处理
python main.py

# 输出示例
开始处理 11 个文件，共 3 个批次...
处理进度: |██████████████████████████████████████████████████| 3/3 (100.0%)
```

### 处理大量文件
```bash
# 处理大量文件（自动使用多进程）
python main.py

# 如果中断，可以恢复
python main.py -r output/saves.txt
```

### 自定义配置
```yaml
# config/config.yaml
max_workers: 8        # 使用8个进程
batch_size: 5         # 每个进程处理5个文件
max_tokens_per_worker: 100000  # 每个worker处理更多token
```

## 改进内容

### 性能优化
- ✅ **多进程并行处理**，大幅提升处理速度
- ✅ **滚动窗口读取**，避免内存溢出
- ✅ **流式写入**，实时保存结果
- ✅ **实时进度条**，清晰显示处理进度

### 可靠性改进
- ✅ **断点续传功能**，支持中断后恢复
- ✅ **进度文件管理**，自动保存和恢复进度
- ✅ **内存优化**，支持处理大量文件
- ✅ **错误恢复**，单个文件失败不影响整体

### 安全性改进
- ✅ 移除硬编码API密钥
- ✅ 使用环境变量管理敏感信息

### 代码质量改进
- ✅ 添加类型注解
- ✅ 改进错误处理
- ✅ 清理重复代码
- ✅ 删除未使用的代码和依赖
- ✅ 添加详细文档
- ✅ 统一文本处理模块

### 功能改进
- ✅ 更好的进度显示
- ✅ 详细的日志记录
- ✅ 输入验证和检查
- ✅ 更健壮的文件处理
- ✅ 随机prompt模板选择
- ✅ 移除固定模式，增加灵活性
- ✅ 修复JSON解析错误，支持Markdown代码块格式
- ✅ 智能GPT摘要功能，保留关键财务数据
- ✅ 自动回退机制，确保系统稳定性

## 注意事项

- 确保OpenAI API密钥有效且有足够额度
- 大文件处理可能需要较长时间，但系统支持断点续传
- 建议在测试环境中先验证配置
- 每次运行会随机选择不同的prompt模板，增加结果的多样性
- GPT摘要功能使用便宜的gpt-4o-mini模型，成本较低
- 多进程处理会占用更多系统资源，请根据机器配置调整 `max_workers`
- 进度文件会自动保存，支持程序中断后恢复处理 